@(annotation: models.annotation.AnnotationLike)(additionalHtml: Html)(implicit session: oxalis.view.AuthedSessionData)

@import models.task.Task
@import models.annotation.AnnotationType
@import scala.async.Async._
@import play.api.libs.concurrent.Execution.Implicits._

@main( ){
  <div id="container" data-tracing-type="@annotation.typ" data-tracing-id="@annotation.id" class="hide clearfix">
    <div id="main" role="main" data-url="@controllers.routes.AnnotationController.info(annotation.typ, annotation.id)">
      <div id="left-menu">
        @if(annotation.restrictions.allowUpdate(session.user)){
          <a href="#" class="btn btn-primary" id="trace-save-button">Save</a>
        } else {
          <button class="btn btn-primary disabled">Read only</button>
        }
        <div id="buttonbar" class="btn-group inline-block">
          @if(annotation.restrictions.allowFinish(session.user)){
            <a href="@controllers.routes.AnnotationController.finishWithRedirect(annotation.typ, annotation.id)" class="btn btn-default btn-small" id="trace-finish-button"><i class="fa fa-check-circle-o"></i>Finish</a>
          }
          <a href="@controllers.routes.AnnotationController.download(annotation.typ, annotation.id)" class="btn btn-default btn-small" id="trace-download-button"><i class="fa fa-download"></i>NML</a>
          <a href="#help-modal" class="btn btn-default btn-small" data-toggle="modal"><i class="fa fa-question-circle"></i>Help</a>
        </div>
        <div id="share-button" class="btn btn-default form-control"><i class="fa fa-share-alt"></i>Share</div>
        <div id="merge-button" class="btn btn-default form-control skeleton-controls">Merge</div>

        <div id="dataset" class="well well-sm">
            @annotation._name.getOrElse(annotation.typ)<br />
            DataSet: <span id="dataset-name"></span><br />
            <span id="zoomFactor"></span>
        </div>
        <div class="input-group">
          <span class="input-group-addon">Position</span>
          <input id="trace-position-input" class="form-control" type="text">
        </div>
        <div class="form-group skeleton-controls">
          <button id="add-node-button" class="btn-primary btn btn-block">
            Add Node (Right-Click)
          </button>
        </div>
        <div class="form-group volume-controls">
          <button id="create-cell-button" class="btn-primary btn btn-block">
            Create new cell (C)
          </button>
        </div>
        <div class="skeleton-controls">
          <div class="input-group" id="trace-rotation">
            <span class="input-group-addon">Rotation</span>
            <input id="trace-rotation-input" class="form-control" type="text">
          </div>
        </div>


        <div id="volume-actions" class="volume-controls">
          <button class="btn btn-default" id="btn-merge">Merge cells</button>
        </div>

        <div id="view-mode" class="skeleton-controls">
          <p>View mode:</p>
          <div class="btn-group wide-toggle-button">
            <button type="button" class="btn btn-default btn-primary" id="view-mode-3planes">Orthogonal</button>
            <button type="button" class="btn btn-default" id="view-mode-sphere">Flight</button>
            <button type="button" class="btn btn-default" id="view-mode-arbitraryplane">Oblique</button>
          </div>
        </div>

        <div class="skeleton-controls" id="trace-mode">
          <div class="btn-group wide-toggle-button big-toggle-button">
            <button type="button" class="btn btn-default" id="trace-mode-trace">Trace</button>
            <button type="button" class="btn btn-default" id="trace-mode-watch">Watch</button>
          </div>
        </div>

        <div id="zoomstep-warning" class="volume-controls">
          <p>Volume tracings are only fully supported at a smaller zoom level. Please zoom in to annotate.</p>
        </div>

        <div id="control-mode" class="volume-controls">
          <p>Control mode:</p>
          <div class="btn-group wide-toggle-button big-toggle-button">
            <button type="button" class="btn btn-default" id="control-mode-move">Move</button>
            <button type="button" class="btn btn-default" id="control-mode-trace">Trace</button>
          </div>
        </div>

        <div class="tabbable" id="lefttabbar">
            <ul class="nav nav-tabs">
              <% if(task) { %>
                <li><a href="#tab0" data-toggle="tab">Task</a></li>
              <% } %>
              @if(additionalHtml.body != ""){
                <li class="active"><a href="#tab1" data-toggle="tab">Review</a></li>
                <li>
              } else {
                <li class="active">
              }
              <a href="#tab2" data-toggle="tab">Options</a></li>
            </ul>

            <div class="tab-content">
              <% if(task) { %>
                <div class="tab-pane" id="tab0">
                  <h5><%=task.type.summary%></h5>
                  <%=task.type.description%>
                </div>
              <% } %>
              @if(additionalHtml.body != ""){
                <div class="tab-pane active" id="tab1">
                  <div id="review-comments">
                    @additionalHtml
                  </div>
                </div>
                <div class="tab-pane" id="tab2" />
              } else {
                <div class="tab-pane active" id="tab2" />
              }
                <div id="status"></div>
                <div id="optionswindow"></div>
              </div>
            </div>

        </div>
      </div>

      <div id="merge">
        <p>Please enter the IDs of the cells to merge or select them in the viewport:</p>
        <div class="input-group">
          <span class="input-group-addon">Cell 1</span>
          <input id="merge-cell1" class="form-control" type="text">
        </div>
        <div class="input-group">
          <span class="input-group-addon">Cell 2</span>
          <input id="merge-cell2" class="form-control" type="text">
        </div>
      </div>

      <div id="tracing">
        <div id="render">
          <div id="help-modal" class="modal fade">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h3>Keyboard Shortcuts</h3>
                </div>
                <div class="modal-body" id="help-modal-body">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>Key binding</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody class="skeleton-plane-controls">
                      <tr><td>Left Mouse drag or Arrow keys</td><td>Move</td></tr>
                      <tr><td>I, O or Alt + Mousewheel</td><td>Zoom in/out</td></tr>
                      <tr><td>F, D or Mousewheel</td><td>Move along Z-Axis</td></tr>
                      <tr><td>Right click</td><td>Set node</td></tr>
                      <tr><td>Shift + Alt + Left click</td><td>Merge two trees</td></tr>
                      <tr><td>K, L</td><td>Scale up/down viewport size</td></tr>
                      <tr><td>B, J</td><td>Set/Jump to last branchpoint</td></tr>
                      <tr><td>S</td><td>Center active node</td></tr>
                    </tbody>
                    <tbody class="volume-controls">
                      <tr><td>Left click</td><td>Set active cell</td></tr>
                      <tr><td>Left Mouse drag</td><td>Move (Move mode) / Add to current Cell (Trace mode)</td></tr>
                      <tr><td>Arrow keys</td><td>Move</td></tr>
                      <tr><td>Shift + Left Mouse drag / Right Mouse drag</td><td>Remove voxels from cell</td></tr>
                      <tr><td>C</td><td>Create new cell</td></tr>
                      <tr><td>M</td><td>Toggle Move / Trace mode</td></tr>
                    </tbody>
                    <tbody class="skeleton-arbitrary-controls">
                      <tr><td>Mouse drag or Arrow keys</td><td>Rotation</td></tr>
                      <tr><td>Space</td><td>Forward</td></tr>
                      <tr><td>I, O</td><td>Zoom in and out</td></tr>
                      <tr><td>Shift + Arrow</td><td>Rotation around Axis</td></tr>
                      <tr><td>B, J</td><td>Set/Jump to last branchpoint</td></tr>
                      <tr><td>R</td><td>Reset rotation</td></tr>
                      <tr><td>W, A, S, D</td><td>Move sideways</td></tr>
                      <tr><td>Y</td><td>Center active node</td></tr>
                      <tr><td>Z, U</td><td>Start/Stop recording waypoints</td></tr>
                      <tr><td>Shift + Space</td><td>Delete active node, Recenter previous node</td></tr>
                    </tbody>
                  </table>
                  <p>For a full list of all keyboard shortcuts <a target="_blank" href="/help/keyboardshortcuts">see the help section.</a></p>
                  <p>We encourage you to read the <a target="_blank" href="/help/faq">tutorials</a> to completely understand how webKnossos works.</p>
                  <p>Introductory  <a target="_blank" href="http://to.do">videos</a> are available.</p>
                 <!-- TODO: change url when feature is ready; quickfix to make tutorial screenshots -->
                  <p>All other settings like moving speed, clipping distance and particle size can be adjusted in the settings tab located to the left.</p>
                </div>
                <div class="modal-footer">
                  <a href="#" class="btn btn-default" data-dismiss="modal">Close</a>
                </div>
              </div>
            </div>
          </div>
          <div id="modal" class="modal fade"></div>
          <div id="merge-modal"></div>
          <div id="inputcatchers">
            <div id="planexy" class="inputcatcher"></div>
            <div id="planeyz" class="inputcatcher"></div>
            <div id="planexz" class="inputcatcher"></div>
            <div id="TDView" class="inputcatcher">
              <div id="TDViewControls" class="btn-group">
                <button type="button" class="btn btn-default btn-sm">3D</button>
                <button type="button" class="btn btn-default btn-sm">
                  <span></span>XY
                </button>
                <button type="button" class="btn btn-default btn-sm">
                  <span></span>YZ
                </button>
                <button type="button" class="btn btn-default btn-sm">
                  <span></span>XZ
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="right-menu" class="skeleton-controls">
        <ul class="nav nav-tabs">
          <li>
            <a href="#tab-tree" data-toggle="tab">Tree Viewer</a>
          </li>
          <li>
            <a href="#tab-trees" data-toggle="tab">Trees</a>
          </li>
          <li class="active">
            <a href="#tab-comments" data-toggle="tab">Comments</a>
          </li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane" id="tab-tree">
            <div id="abstractTreeViewer">
              <canvas id="abstractTreeViewerCanvas"></canvas>
            </div>
          </div>
          <div class="tab-pane" id="tab-trees">
            <div id="tree-navbar">
              <div class="btn-group">
                <button class="btn btn-default" id="tree-create-button"><i class="fa fa-plus"></i>Create tree</button>
                <button class="btn btn-default" id="tree-delete-button"><i class="fa fa-trash-o"></i>Delete tree</button>
              </div>
              <div class="btn-group pull-right">
                <button class="btn btn-default" id="tree-color-shuffle" title="Change color"><i class="fa fa-adjust"></i></button>
                <button class="btn btn-default" id="tree-color-shuffle-all" title="Shuffle all Colors"><i class="fa fa-random"></i></button>
                <button class="btn btn-default dropdown-toggle" data-toggle="dropdown" id="tree-sort-button" title="Sort">
                  <i class="fa fa-sort-alpha-asc"></i>
                </button>
                <ul class="dropdown-menu pull-right" id="tree-sort">
                  <li>
                    <a href="#" data-sort="name">by name <i class="fa fa-check" id="sort-name-icon"></i></a>
                  </li>
                  <li>
                    <a href="#" data-sort="id">by creation time <i class="fa fa-check" id= "sort-id-icon"></i></a>
                  </li>
                </ul>
              </div>
              <div class="input-group">
                <span class="input-group-btn">
                  <button class="btn btn-default" id="tree-prev-button"><i class="fa fa-arrow-left"></i></button>
                </span>
                <input name="name" id="tree-name-input" class="form-control" maxlength="30" type="text" autocomplete="off">
                <span class="input-group-btn">
                  <button class="btn btn-default" id="tree-name-submit"><i class="fa fa-check"></i></button>
                </span>
                <span class="input-group-btn">
                  <button class="btn btn-default" id="tree-next-button"><i class="fa fa-arrow-right"></i></button>
                </span>
              </div>
            </div>
            <div id="tree-list-container">
              <ul id="tree-list"></ul>
            </div>
          </div>
          <div class="tab-pane active" id="tab-comments">
            <div class="input-group" id="comment-navbar">
              <div class="input-group-btn">
                <button class="btn btn-default" id="comment-previous"><i class="fa fa-arrow-left"></i></button>
              </div>
              <input class="form-control" id="comment-input" type="text" placeholder="Add comment">
              <div class="input-group-btn">
                <button class="btn btn-default" id="comment-next"><i class="fa fa-arrow-right"></i></button>
                <button class="btn btn-default dropdown-toggle" data-toggle="dropdown" id="comment-sort-button" title="sort">
                  <i class="fa fa-sort-alpha-asc"></i>
                </button>
                <ul class="dropdown-menu pull-right" role="menu" id="comment-sort">
                  <li>
                    <a href="#" data-sort="asc">
                      Ascending
                      <i class="fa fa-check" id="sort-asc-icon"></i>
                    </a>
                  </li>
                  <li>
                    <a href="#" data-sort="desc">
                      Descending
                      <i class="fa fa-check" id= "sort-desc-icon"></i>
                    </a>
                </ul>
              </div>
            </div>
            <div id="comment-container">
              <ul id="comment-list"></ul>
            </div>
          </div>
        </div>
      </div>
  </div> <!--! end of #container -->
  <!-- JavaScript at the bottom for fast page loading -->

}
