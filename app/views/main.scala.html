@( conf: utils.WkConf, selectedTheme: String )
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta name="commit-hash" content="@(webknossos.BuildInfo.commitHash)" />
    <title>@(conf.WebKnossos.tabTitle)</title>
    @if(conf.Features.isDemoInstance){
    <meta
      name="description"
      content="Annotate and explore large 3D datasets with webKnossos. Fast neurite skeletonization. 3D voxel painting. Collaboration, sharing and crowdsourcing."
    />
    <meta
      name="keywords"
      content="connectomics, data annotation, image segmentation, electron microscopy, light microscopy, fluorescence microscopy, skeletonization, webknossos"
    />
    } else {
    <meta name="robot" content="noindex" />
    }
    <link rel="shortcut icon" type="image/png" href="/assets/images/favicon.png" />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="/assets/bundle/vendors~dark~light.css?nocache=@(webknossos.BuildInfo.commitHash)"
    />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="/assets/fonts/titillium-web.css?nocache=@(webknossos.BuildInfo.commitHash)"
    />
    <script>
      let initialTheme = "@(selectedTheme)";
      if (initialTheme === "auto") {
        initialTheme = 
          window.matchMedia('(prefers-color-scheme: dark)').media !== "not all" && 
          window.matchMedia('(prefers-color-scheme: dark)').matches ? 
            "dark" : 
            "light";
      }
      document.documentElement.style.display = 'none';
      document.head.insertAdjacentHTML(
        'beforeend',
        '<link ' +
          'id="primary-stylesheet" ' +
          'rel="stylesheet" ' +
          'type="text/css" ' +
          'media="screen" ' +
          'href="/assets/bundle/' + initialTheme + '.css?nocache=@(webknossos.BuildInfo.commitHash)" ' +
          'onload="document.documentElement.style.display = \'\'" ' + 
        '/>');
    </script>
    <script
      data-airbrake-project-id="@(conf.Airbrake.projectID)"
      data-airbrake-project-key="@(conf.Airbrake.projectKey)"
      data-airbrake-environment-name="@(conf.Airbrake.environment)"
    ></script>
    <script src="/assets/bundle/vendors~main.js?nocache=@(webknossos.BuildInfo.commitHash)"></script>
    <script src="/assets/bundle/main.js?nocache=@(webknossos.BuildInfo.commitHash)"></script>
    @if(conf.Features.isDemoInstance){
    <script type="text/javascript" src="https://app.olvy.co/script.js" defer="defer"></script>
    <script>
      // Suppress warning emitted by Olvy because it tries to eagerly initialize
      window.OlvyConfig = null;
    </script>
    }
  </head>
  <body>
    <main id="main-container"></main>

    @if(conf.GoogleAnalytics.trackingId.nonEmpty) {
    <script>
      (function(i, s, o, g, r, a, m) {
        i["GoogleAnalyticsObject"] = r;
        (i[r] =
          i[r] ||
          function() {
            (i[r].q = i[r].q || []).push(arguments);
          }),
          (i[r].l = 1 * new Date());
        (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m);
      })(window, document, "script", "https://www.google-analytics.com/analytics.js", "ga");

      ga("create", "@(conf.GoogleAnalytics.trackingId)", "auto");
      ga("set", "anonymizeIp", true);
      ga("send", "pageview");
    </script>
    }
    <script type="module">
      // Use ES module import syntax to import functionality from the module
      // that we have compiled.
      //
      // Note that the `default` import is an initialization function which
      // will "boot" the module and make it ready to use. Currently browsers
      // don't support natively imported WebAssembly as an ES module, but
      // eventually the manual initialization won't be required!
      //import { memory } from '/assets/bundle/marching_cubes_wasm/marching_cubes_wasm_bg.js';
      import init, { MarchingCubes, get_memory } from '/assets/bundle/marching_cubes_wasm/marching_cubes_wasm.js';

      async function run() {
        // First up we need to actually load the wasm file, so we use the
        // default export to inform it where the wasm file is located on the
        // server, and then we wait on the returned promise to wait for the
        // wasm to be loaded.
        //
        // It may look like this: `await init('./pkg/without_a_bundler_bg.wasm');`,
        // but there is also a handy default inside `init` function, which uses
        // `import.meta` to locate the wasm file relatively to js file.
        //
        // Note that instead of a string you can also pass in any of the
        // following things:
        //
        // * `WebAssembly.Module`
        //
        // * `ArrayBuffer`
        //
        // * `Response`
        //
        // * `Promise` which returns any of the above, e.g. `fetch("./path/to/wasm")`
        //
        // This gives you complete control over how the module is loaded
        // and compiled.
        //
        // Also note that the promise, when resolved, yields the wasm module's
        // exports which is the same as importing the `*_bg` module in other
        // modes
        await init();

        // And afterwards we can use all the functionality defined in wasm.
        // chunk u32 with segment id
        // output mesh (vertices[faces]), neighbors: array[int] (indices into offset table)
        // const NEIGHBOR_LOOKUP = [[0, 0, -1], [0, -1, 0], [-1, 0, 0], [0, 0, 1], [0, 1, 0], [1, 0, 0]];
        window.marching_cubes = function(cube, segment_id, width, height, depth) {
          // cube: Uint32Array, segment_id: uin32
          // width, height, depth all usize
          const marching_cubes = MarchingCubes.new(width, height, depth);
          const cube_ptr = marching_cubes.get_cube_ptr();
          const memory = get_memory();
          const marching_cubes_cube = new Uint32Array(memory.buffer, cube_ptr, width * height * depth);
          //Copy segmentation cube to webassembly
          debugger
          marching_cubes_cube.set(cube);
          marching_cubes.marche(segment_id);
          return new Float32Array(memory.buffer, marching_cubes.get_triangle_ptr(), marching_cubes.get_triangle_size());
        }
        const width = 2
        const height = 2
        const depth = 2
        const cube = new Uint32Array([5, 5, 5, 5, 1, 1, 1, 1]);

        console.log(window.marching_cubes(cube, 5, width, height, depth));
      }

      run();
    </script>
  </body>
</html>
