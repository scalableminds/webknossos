version: 2
jobs:
  build_test_deploy:
    machine: true
    environment:
      USER_NAME: circleci
      USER_UID: 1001
      USER_GID: 1001
      TZ: Europe/Berlin
    steps:
      - checkout
      - run:
          name: Send Slack notification (master only)
          command: .circleci/slack-notification.sh

  nightly:
    docker:
      - image: scalableminds/puppeteer:master
    steps:
      - checkout
      - run:
          name: Remove dev-deployment
          command: >
            curl
            -X POST
            -H "X-Auth-Token: $RELEASE_API_TOKEN"
            https://kube.scm.io/hooks/remove/webknossos/dev/master?user=CI+%28nightly%29
      - run:
          name: Wait 3min
          command: sleep 180
      - run:
          name: Install dev-deployment
          command: >
            curl
            -X POST
            -H "X-Auth-Token: $RELEASE_API_TOKEN"
            https://kube.scm.io/hooks/install/webknossos/dev/master?user=CI+%28nightly%29
      - run:
          name: Install dependencies and sleep at least 3min
          command: |
            yarn install --frozen-lockfile &
            sleep 180 &
            wait
      - run:
          name: Refresh datasets
          command: curl https://master.webknossos.xyz/data/triggers/checkInboxBlocking?token=secretScmBoyToken
      - run:
          name: Run screenshot-tests
          command: |
            for i in {1..5}; do # retry
              URL=https://master.webknossos.xyz/ \
              yarn test-screenshot && s=0 && break || s=$?
              sleep 30
            done
            (exit $s)

      - store_artifacts:
          path: app/assets/javascripts/test/screenshots

workflows:
  version: 2
  default:
    jobs:
      - build_test_deploy:
          filters:
            tags:
              only: /.*/
  nightly:
    jobs:
      - nightly
    triggers:
      - schedule:
          # 02:15 AM UTC
          cron: "15 2 * * *"
          filters:
            branches:
              only:
                - master
